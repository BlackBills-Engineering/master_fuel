# Система детального логирования FuelMaster - РЕЗЮМЕ ИЗМЕНЕНИЙ

## Что было добавлено

### 1. Новый модуль логирования (`app/logging_config.py`)
- Централизованная настройка логирования для всего проекта
- Автоматическое создание и ротация файлов логов
- Специальные функции для hex-данных и транзакций
- Настройка через переменные окружения

### 2. Детализированное логирование драйвера (`app/mekser/driver.py`)
**ДОБАВЛЕНО:**
- Полное логирование каждой транзакции (начало/конец)
- Детальный разбор каждого блока команд (CD1, CD3, CD4, CD5)
- Hex-дамп всех отправляемых и получаемых данных
- Логирование формирования кадров протокола
- Детальный парсинг ответов (DC1, DC2, DC3, DC7, DC9)
- Логирование CRC проверок и таймаутов
- Специальные методы для расшифровки транзакций

**НОВЫЕ МЕТОДЫ:**
- `_get_transaction_name()` - получение названий транзакций
- `_log_transaction_details()` - детальное логирование команд
- `_log_received_frame_details()` - анализ полученных кадров
- `_get_response_transaction_name()` - названия ответных транзакций
- `_log_response_transaction_details()` - разбор ответов

### 3. Расширенное логирование PumpMaster (`app/pumpmaster.py`)
**ДОБАВЛЕНО:**
- Логирование всех этапов авторизации с preset'ами
- Детальный разбор команд (объем/сумма → BCD конвертация)
- Полное логирование инициализации насосов
- Пошаговый парсинг полученных фреймов
- Детальная обработка событий (сопла, объем, статус)
- Логирование таблиц grade для каждого насоса

**УЛУЧШЕНО:**
- Метод `authorize()` - логирует каждый блок команды
- Метод `command()` - показывает название команды
- Метод `_parse()` - детальный анализ фреймов и CRC
- Метод `_handle_dc()` - полный разбор всех типов транзакций
- Использование `log_hex_data()` и `log_transaction_summary()`

### 4. API логирование (`app/api.py`)
**ДОБАВЛЕНО:**
- Логирование всех HTTP запросов к API
- Детальное логирование preset запросов
- Логирование WebSocket соединений и событий
- Обработка ошибок с детальным логированием

### 5. Файловая структура логов
**СОЗДАЕТСЯ:**
```
logs/
├── fuel_master.log              # Все логи системы
├── driver_communication.log     # Только драйвер (детали протокола)
└── pump_transactions.log        # Только PumpMaster (события насосов)
```

### 6. Демонстрационные скрипты
- `test_logging.py` - полное тестирование системы логирования
- `logging_demo.py` - демонстрация различных типов логирования
- `LOGGING_GUIDE.md` - подробная документация

## Ключевые возможности

### Детальное логирование транзакций
```
=== TRANSACTION START: addr=0x50, blocks=2, timeout=1.00s ===
Block 1: CD3-PRESET_VOLUME (0x03) - 03040000270F
  └─ Preset Volume: 10000 (10.000 L)
Block 2: CD1-COMMAND (0x01) - 010106
  └─ Command: AUTHORIZE (0x06)
Built frame for addr 0x50: 0250F00007030400002700F010106...
>>> PUMP 0x50: FRAME_SEND 2 blocks
```

### Hex-дамп данных
```
SENDING to pump 0x50 (15 bytes): 0250F00007030400002700F0101065A3E03FA
RECEIVED from pump 0x50 (12 bytes): 0250F0000301010154A103FA
```

### Расшифровка ответов
```
Response frame breakdown:
  STX: 0x02, ADDR: 0x50, CTRL: 0xF0, SEQ: 0x00, LEN: 3
  Transaction 1: DC1-PUMP_STATUS (DC1) - 0101
    └─ Status: AUTHORIZED (0x02)
```

### События в реальном времени
```
>>> PUMP 0x50: NOZZLE_EVENT noz2 OUT
Nozzle event: id=2, TAKEN, side=right, grade=95, price=45.00 RUB
>>> PUMP 0x50: VOLUME_UPDATE 5.123L / 230.24RUB
```

## Использование

### Автоматическое включение
Система активируется автоматически при запуске приложения.

### Ручная настройка
```python
from app.logging_config import setup_logging
setup_logging(log_level="DEBUG", log_to_file=True)
```

### Переменные окружения
```bash
export FUEL_MASTER_LOG_LEVEL=DEBUG
export FUEL_MASTER_LOG_TO_FILE=1
```

### Просмотр логов
```bash
# Все логи в реальном времени
tail -f logs/fuel_master.log

# Только ошибки
grep "ERROR\|WARNING" logs/fuel_master.log

# Только транзакции конкретного насоса
grep "0x50" logs/driver_communication.log
```

## Тестирование

```bash
# Демонстрация системы логирования
python logging_demo.py

# Полное тестирование с реальным насосом
python test_logging.py
```

Система теперь обеспечивает полную прозрачность всех операций с ТРК - от формирования команд до обработки ответов!
